# ASPNETCORE + gRPC + Docker + Nginx

# 1 - Create API locally and get local communication to work

### Startup - ConfigureServices
> services.AddGrpc(opts => 
  {
      opts.EnableDetailedErrors = true;
  });
  
  services.AddControllers();

### Program.cs - Main
After endless tries I found some SO posts mentioning splitting the ports like this. Then it finally worked locally.

> webBuilder.ConfigureKestrel(options =>
  {
      // gRPC
      options.ListenAnyIP(5001, o => o.Protocols = HttpProtocols.Http2);
      // HTTP
      options.ListenAnyIP(5000, o => o.Protocols = HttpProtocols.Http1); 
  });

### Docker it up

Using autogenerated Dockerfile (with some extra ports exposed for testing purposes)

> FROM mcr.microsoft.com/dotnet/core/aspnet:3.0-buster-slim AS base
  WORKDIR /app
  EXPOSE 80
  EXPOSE 443
  EXPOSE 5000
  EXPOSE 5001
  
  FROM mcr.microsoft.com/dotnet/core/sdk:3.0-buster AS build
  WORKDIR /src
  COPY ["Smarthome.ServerApi.csproj", "."]
  RUN dotnet restore "Smarthome.ServerApi.csproj"
  COPY . .
  WORKDIR "/src"
  RUN dotnet build "Smarthome.ServerApi.csproj" -c Release -o /app/build
  
  FROM build AS publish
  RUN dotnet publish "Smarthome.ServerApi.csproj" -c Release -o /app/publish
  
  FROM base AS final
  WORKDIR /app
  COPY --from=publish /app/publish .
  ENTRYPOINT ["dotnet", "Smarthome.ServerApi.dll"] 

From the looks of it, it worked without issues. 

### Nginx

> upstream smarthome {
    server smarthomeapi-server:5000;
}
upstream smarthome2 {
    server smarthomeapi-server:5001;
}
...
server {
    listen [::]:443 ssl http2;
    listen 443 ssl http2;
    ...
    location /smarthome/ {
        proxy_pass http://smarthome;
        proxy_set_header Host $host;
        rewrite  ^/smarthome/(.*)  /$1 break;

	#       grpc_pass grpc://smarthome2;

    }
    location /greet.Greeter/SayHello/ {
        # proxy_pass http://smarthome;

        grpc_pass grpc://smarthome2;
        #rewrite  ^/smarthome5001/(.*)  /$1 break;


      #  proxy_set_header Host $host;
    }
    location /smarthomegrpc/ {
         grpc_pass grpc://smarthome2;
         rewrite ^/smarthomegrpc/(.*)  /$1 break;
	#         proxy_set_header Host $host;
    }


Can access the rest API through the /smarthome/ endpoint. Am still unable to access the gRPC endpoints. As you can see I tried various things with the 'rewrite' command as well. No luck.

With this config however
> location /greet.Greeter/ {
        # proxy_pass http://smarthome;

        grpc_pass grpc://smarthome2;
        #rewrite  ^/smarthome5001/(.*)  /$1 break;


      #  proxy_set_header Host $host;
    }

And requesting from the client like this: 

> var channel = GrpcChannel.ForAddress("https://workotters.com", new GrpcChannelOptions
  {
      HttpClient = new HttpClient(httpClientHandler)
  });

It suddenly worked! :D 

### Testing Docker API with grpc_cli

> ./grpc_cli call 172.17.0.2:5001 greet.Greeter/SayHellos "name: 'world'" --protofiles=greet.proto
> connecting to 172.17.0.2:5001
> Received initial metadata from server:
> date : Mon, 10 Aug 2020 00:04:05 GMT
> server : Kestrel
> message: "How are you world? 1"
> message: "How are you world? 2"
> message: "How are you world? 3"
...

Worked!



## Failed call:

##### ASPNETCORE API log:
dbug: Microsoft.AspNetCore.Server.Kestrel[39]
      Connection id "0HM1SM0Q2EKT6" accepted.
dbug: Microsoft.AspNetCore.Server.Kestrel[1]
      Connection id "0HM1SM0Q2EKT6" started.
info: Microsoft.AspNetCore.Hosting.Diagnostics[1]
      Request starting HTTP/2 GET http://smarthome2/greet.Greeter/SayHello/
dbug: Microsoft.AspNetCore.Routing.Matching.DfaMatcher[1001]
      2 candidate(s) found for the request path '/greet.Greeter/SayHello/'
dbug: Microsoft.AspNetCore.Routing.Matching.DfaMatcher[1003]
      Endpoint 'gRPC - Unimplemented method for greet.Greeter' with route pattern 'greet.Greeter/{unimplementedMethod}' was rejected by constraint 'contentType':'Grpc.AspNetCore.Server.Model.Internal.ServiceRouteBuilder`1+GrpcUnimplementedConstraint[Smarthome.ServerApi.Controllers.GreeterService]' with value '(null)' for the request path '/greet.Greeter/SayHello/'
dbug: Microsoft.AspNetCore.Routing.Matching.DfaMatcher[1004]
      Endpoint 'gRPC - Unimplemented method for greet.Greeter' with route pattern 'greet.Greeter/{unimplementedMethod}' is not valid for the request path '/greet.Greeter/SayHello/'
dbug: Microsoft.AspNetCore.Routing.Matching.DfaMatcher[1003]
      Endpoint 'gRPC - Unimplemented service' with route pattern '{unimplementedService}/{unimplementedMethod}' was rejected by constraint 'contentType':'Grpc.AspNetCore.Server.Model.Internal.ServiceRouteBuilder`1+GrpcUnimplementedConstraint[Smarthome.ServerApi.Controllers.GreeterService]' with value '(null)' for the request path '/greet.Greeter/SayHello/'
dbug: Microsoft.AspNetCore.Routing.Matching.DfaMatcher[1004]
      Endpoint 'gRPC - Unimplemented service' with route pattern '{unimplementedService}/{unimplementedMethod}' is not valid for the request path '/greet.Greeter/SayHello/'
dbug: Microsoft.AspNetCore.Routing.EndpointRoutingMiddleware[2]
      Request did not match any endpoints
info: Microsoft.AspNetCore.Hosting.Diagnostics[2]
      Request finished in 6.161300000000001ms 404
dbug: Microsoft.AspNetCore.Server.Kestrel.Transport.Sockets[6]
      Connection id "0HM1SM0Q2EKT6" received FIN.
dbug: Microsoft.AspNetCore.Server.Kestrel[36]
      Connection id "0HM1SM0Q2EKT6" is closed. The last processed stream ID was 1.
dbug: Microsoft.AspNetCore.Server.Kestrel[2]
      Connection id "0HM1SM0Q2EKT6" stopped.
dbug: Microsoft.AspNetCore.Server.Kestrel.Transport.Sockets[7]
      Connection id "0HM1SM0Q2EKT6" sending FIN because: "The Socket transport's send loop completed gracefully."

Nginx log:
82.102.20.219 - - [09/Aug/2020:22:22:31 +0000] "POST /greet.Greeter/SayHello HTTP/2.0" 301 162 "-" "grpc-dotnet/2.30.0.0" "-"
82.102.20.219 - - [09/Aug/2020:22:22:31 +0000] "GET /greet.Greeter/SayHello/ HTTP/2.0" 404 0 "-" "grpc-dotnet/2.30.0.0" "-"
82.102.20.219 - - [09/Aug/2020:22:32:24 +0000] "POST /greet.Greeter/SayHello HTTP/2.0" 301 162 "-" "grpc-dotnet/2.30.0.0" "-"
82.102.20.219 - - [09/Aug/2020:22:32:24 +0000] "GET /greet.Greeter/SayHello/ HTTP/2.0" 404 0 "-" "grpc-dotnet/2.30.0.0" "-"