<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>

    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!--Description-->

    

    
        <meta name="description" content="ASPNETCORE + gRPC + Docker + Nginx1 - Create API locally and get local communication to workStartup - ConfigureServices
services.AddGrpc(opts =&amp;gt;  {"/>
    

    <!--Author-->
    
        <meta name="author" content="Mikkel V"/>
    

    <!--Open Graph Title-->
    
        <meta property="og:title" content="Is this a blog?"/>
    

    <!--Open Graph Description-->
    
        <meta property="og:description" content="ASPNETCORE + gRPC + Docker + Nginx1 - Create API locally and get local communication to workStartup - ConfigureServices
services.AddGrpc(opts =&amp;gt;  {"/>
    

    <!--Open Graph Site Name-->
        <meta property="og:site_name" content="Is this a blog?"/>

    <!--Type page-->
    
        <meta property="og:type" content="website"/>
    

    <!--Page Cover-->
    
    

        <meta name="twitter:card" content="summary_large_image"/>

    

    

    <!-- Title -->
    
    <title>Is this a blog?</title>

    <!-- Bootstrap Core CSS -->
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"/>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/style.css">


    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"/>
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"/>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="//oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- Gallery -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.css" type="text/css" rel="stylesheet"/>

    <!-- Google Analytics -->
    


    <!-- favicon -->
    

<meta name="generator" content="Hexo 4.2.1"></head>


<body>

    <!-- Menu -->
    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Is this a blog?</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                
                    <li>
                        <a href="https://github.com/M-AV" target="_blank" rel="noopener">
                            
                                <i class="fa fa-github fa-stack-2x"></i>
                            
                        </a>
                    </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>

    <!-- Main Content -->
    


    <section class="main">
        <!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->

<!-- Page Header -->
<!-- Set your background image for this header in your post front-matter: cover -->
<!-- Beginning of article full -->

<header class="intro-header" style="background-image: url('')">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <h1>Untitled</h1>
                    
                    <span class="meta">
                        <!-- Date and Author -->
                        
                        
                            2020-08-11
                        
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- End of article-full-->
<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Tags and categories -->
           

            <!-- Gallery -->
            

            <!-- Post Main Content -->
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <h1 id="ASPNETCORE-gRPC-Docker-Nginx"><a href="#ASPNETCORE-gRPC-Docker-Nginx" class="headerlink" title="ASPNETCORE + gRPC + Docker + Nginx"></a>ASPNETCORE + gRPC + Docker + Nginx</h1><h1 id="1-Create-API-locally-and-get-local-communication-to-work"><a href="#1-Create-API-locally-and-get-local-communication-to-work" class="headerlink" title="1 - Create API locally and get local communication to work"></a>1 - Create API locally and get local communication to work</h1><h3 id="Startup-ConfigureServices"><a href="#Startup-ConfigureServices" class="headerlink" title="Startup - ConfigureServices"></a>Startup - ConfigureServices</h3><blockquote>
<p>services.AddGrpc(opts =&gt;<br>  {<br>      opts.EnableDetailedErrors = true;<br>  });</p>
</blockquote>
<p>  services.AddControllers();</p>
<h3 id="Program-cs-Main"><a href="#Program-cs-Main" class="headerlink" title="Program.cs - Main"></a>Program.cs - Main</h3><p>After endless tries I found some SO posts mentioning splitting the ports like this. Then it finally worked locally.</p>
<blockquote>
<p>webBuilder.ConfigureKestrel(options =&gt;<br>  {<br>      // gRPC<br>      options.ListenAnyIP(5001, o =&gt; o.Protocols = HttpProtocols.Http2);<br>      // HTTP<br>      options.ListenAnyIP(5000, o =&gt; o.Protocols = HttpProtocols.Http1);<br>  });</p>
</blockquote>
<h3 id="Docker-it-up"><a href="#Docker-it-up" class="headerlink" title="Docker it up"></a>Docker it up</h3><p>Using autogenerated Dockerfile (with some extra ports exposed for testing purposes)</p>
<blockquote>
<p>FROM mcr.microsoft.com/dotnet/core/aspnet:3.0-buster-slim AS base<br>  WORKDIR /app<br>  EXPOSE 80<br>  EXPOSE 443<br>  EXPOSE 5000<br>  EXPOSE 5001</p>
</blockquote>
<p>  FROM mcr.microsoft.com/dotnet/core/sdk:3.0-buster AS build<br>  WORKDIR /src<br>  COPY [“Smarthome.ServerApi.csproj”, “.”]<br>  RUN dotnet restore “Smarthome.ServerApi.csproj”<br>  COPY . .<br>  WORKDIR “/src”<br>  RUN dotnet build “Smarthome.ServerApi.csproj” -c Release -o /app/build</p>
<p>  FROM build AS publish<br>  RUN dotnet publish “Smarthome.ServerApi.csproj” -c Release -o /app/publish</p>
<p>  FROM base AS final<br>  WORKDIR /app<br>  COPY –from=publish /app/publish .<br>  ENTRYPOINT [“dotnet”, “Smarthome.ServerApi.dll”] </p>
<p>From the looks of it, it worked without issues. </p>
<h3 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h3><blockquote>
<p>upstream smarthome {<br>    server smarthomeapi-server:5000;<br>}<br>upstream smarthome2 {<br>    server smarthomeapi-server:5001;<br>}<br>…<br>server {<br>    listen [::]:443 ssl http2;<br>    listen 443 ssl http2;<br>    …<br>    location /smarthome/ {<br>        proxy_pass <a href="http://smarthome" target="_blank" rel="noopener">http://smarthome</a>;<br>        proxy_set_header Host $host;<br>        rewrite  ^/smarthome/(.*)  /$1 break;</p>
</blockquote>
<pre><code>#       grpc_pass grpc://smarthome2;

}
location /greet.Greeter/SayHello/ {
    # proxy_pass http://smarthome;

    grpc_pass grpc://smarthome2;
    #rewrite  ^/smarthome5001/(.*)  /$1 break;


  #  proxy_set_header Host $host;
}
location /smarthomegrpc/ {
     grpc_pass grpc://smarthome2;
     rewrite ^/smarthomegrpc/(.*)  /$1 break;
#         proxy_set_header Host $host;
}</code></pre><p>Can access the rest API through the /smarthome/ endpoint. Am still unable to access the gRPC endpoints. As you can see I tried various things with the ‘rewrite’ command as well. No luck.</p>
<p>With this config however</p>
<blockquote>
<p>location /greet.Greeter/ {<br>        # proxy_pass <a href="http://smarthome" target="_blank" rel="noopener">http://smarthome</a>;</p>
</blockquote>
<pre><code>    grpc_pass grpc://smarthome2;
    #rewrite  ^/smarthome5001/(.*)  /$1 break;


  #  proxy_set_header Host $host;
}</code></pre><p>And requesting from the client like this: </p>
<blockquote>
<p>var channel = GrpcChannel.ForAddress(“<a href="https://workotters.com&quot;" target="_blank" rel="noopener">https://workotters.com&quot;</a>, new GrpcChannelOptions<br>  {<br>      HttpClient = new HttpClient(httpClientHandler)<br>  });</p>
</blockquote>
<p>It suddenly worked! :D </p>
<h3 id="Testing-Docker-API-with-grpc-cli"><a href="#Testing-Docker-API-with-grpc-cli" class="headerlink" title="Testing Docker API with grpc_cli"></a>Testing Docker API with grpc_cli</h3><blockquote>
<p>./grpc_cli call 172.17.0.2:5001 greet.Greeter/SayHellos “name: ‘world’” –protofiles=greet.proto<br>connecting to 172.17.0.2:5001<br>Received initial metadata from server:<br>date : Mon, 10 Aug 2020 00:04:05 GMT<br>server : Kestrel<br>message: “How are you world? 1”<br>message: “How are you world? 2”<br>message: “How are you world? 3”<br>…</p>
</blockquote>
<p>Worked!</p>
<h2 id="Failed-call"><a href="#Failed-call" class="headerlink" title="Failed call:"></a>Failed call:</h2><h5 id="ASPNETCORE-API-log"><a href="#ASPNETCORE-API-log" class="headerlink" title="ASPNETCORE API log:"></a>ASPNETCORE API log:</h5><p>dbug: Microsoft.AspNetCore.Server.Kestrel[39]<br>      Connection id “0HM1SM0Q2EKT6” accepted.<br>dbug: Microsoft.AspNetCore.Server.Kestrel[1]<br>      Connection id “0HM1SM0Q2EKT6” started.<br>info: Microsoft.AspNetCore.Hosting.Diagnostics[1]<br>      Request starting HTTP/2 GET <a href="http://smarthome2/greet.Greeter/SayHello/" target="_blank" rel="noopener">http://smarthome2/greet.Greeter/SayHello/</a><br>dbug: Microsoft.AspNetCore.Routing.Matching.DfaMatcher[1001]<br>      2 candidate(s) found for the request path ‘/greet.Greeter/SayHello/‘<br>dbug: Microsoft.AspNetCore.Routing.Matching.DfaMatcher[1003]<br>      Endpoint ‘gRPC - Unimplemented method for greet.Greeter’ with route pattern ‘greet.Greeter/{unimplementedMethod}’ was rejected by constraint ‘contentType’:’Grpc.AspNetCore.Server.Model.Internal.ServiceRouteBuilder<code>1+GrpcUnimplementedConstraint[Smarthome.ServerApi.Controllers.GreeterService]&#39; with value &#39;(null)&#39; for the request path &#39;/greet.Greeter/SayHello/&#39;
dbug: Microsoft.AspNetCore.Routing.Matching.DfaMatcher[1004]
      Endpoint &#39;gRPC - Unimplemented method for greet.Greeter&#39; with route pattern &#39;greet.Greeter/{unimplementedMethod}&#39; is not valid for the request path &#39;/greet.Greeter/SayHello/&#39;
dbug: Microsoft.AspNetCore.Routing.Matching.DfaMatcher[1003]
      Endpoint &#39;gRPC - Unimplemented service&#39; with route pattern &#39;{unimplementedService}/{unimplementedMethod}&#39; was rejected by constraint &#39;contentType&#39;:&#39;Grpc.AspNetCore.Server.Model.Internal.ServiceRouteBuilder</code>1+GrpcUnimplementedConstraint[Smarthome.ServerApi.Controllers.GreeterService]’ with value ‘(null)’ for the request path ‘/greet.Greeter/SayHello/‘<br>dbug: Microsoft.AspNetCore.Routing.Matching.DfaMatcher[1004]<br>      Endpoint ‘gRPC - Unimplemented service’ with route pattern ‘{unimplementedService}/{unimplementedMethod}’ is not valid for the request path ‘/greet.Greeter/SayHello/‘<br>dbug: Microsoft.AspNetCore.Routing.EndpointRoutingMiddleware[2]<br>      Request did not match any endpoints<br>info: Microsoft.AspNetCore.Hosting.Diagnostics[2]<br>      Request finished in 6.161300000000001ms 404<br>dbug: Microsoft.AspNetCore.Server.Kestrel.Transport.Sockets[6]<br>      Connection id “0HM1SM0Q2EKT6” received FIN.<br>dbug: Microsoft.AspNetCore.Server.Kestrel[36]<br>      Connection id “0HM1SM0Q2EKT6” is closed. The last processed stream ID was 1.<br>dbug: Microsoft.AspNetCore.Server.Kestrel[2]<br>      Connection id “0HM1SM0Q2EKT6” stopped.<br>dbug: Microsoft.AspNetCore.Server.Kestrel.Transport.Sockets[7]<br>      Connection id “0HM1SM0Q2EKT6” sending FIN because: “The Socket transport’s send loop completed gracefully.”</p>
<p>Nginx log:<br>82.102.20.219 - - [09/Aug/2020:22:22:31 +0000] “POST /greet.Greeter/SayHello HTTP/2.0” 301 162 “-“ “grpc-dotnet/2.30.0.0” “-“<br>82.102.20.219 - - [09/Aug/2020:22:22:31 +0000] “GET /greet.Greeter/SayHello/ HTTP/2.0” 404 0 “-“ “grpc-dotnet/2.30.0.0” “-“<br>82.102.20.219 - - [09/Aug/2020:22:32:24 +0000] “POST /greet.Greeter/SayHello HTTP/2.0” 301 162 “-“ “grpc-dotnet/2.30.0.0” “-“<br>82.102.20.219 - - [09/Aug/2020:22:32:24 +0000] “GET /greet.Greeter/SayHello/ HTTP/2.0” 404 0 “-“ “grpc-dotnet/2.30.0.0” “-“</p>


                
            </div>

            <!-- Comments -->
            
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    


                </div>
            
        </div>
    </div>
</article>

    </section>






    <!-- Footer -->
    <hr />

<!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    

                    

                    

                    

                    

                    
                </ul>
                <p class="copyright text-muted">&copy; 2020 Mikkel V<br></p>
            </div>
        </div>
    </div>
</footer>


    <!-- After footer scripts -->
    
<!-- jQuery -->
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<!-- Bootstrap -->
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>

<!-- Gallery -->
<script src="//cdnjs.cloudflare.com/ajax/libs/featherlight/1.3.5/featherlight.min.js" type="text/javascript" charset="utf-8"></script>

<!-- Disqus Comments -->



</body>

</html>